<!DOCTYPE html>

<html>
<head>
  <title>Compute.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Compute.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>C = {}

MSGInvalidArgumentsToObservableArray = <span class="hljs-string">'The argument passed when initializing an observable array must be an array, or null, or undefined.'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="environment-detection-">Environment detection.</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>Test whether we are running <span class="hljs-keyword">in</span> a browser. If so, we<span class="hljs-string">'ll define Compute on the
window object. Otherwise, assume we are in Node and we'</span>ll <span class="hljs-reserved">export</span> Compute via
<span class="hljs-built_in">module</span>.exports. Also, <span class="hljs-keyword">try</span> to load knockout <span class="hljs-keyword">and</span> silently fall back to using
our own observables <span class="hljs-keyword">if</span> knockout <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> installed.</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span>
  <span class="hljs-built_in">window</span>.Compute = C
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">module</span>
  <span class="hljs-built_in">module</span>.exports = C

  <span class="hljs-keyword">try</span>
    ko = <span class="hljs-built_in">require</span> <span class="hljs-string">'knockout'</span>
  <span class="hljs-keyword">catch</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>    KO <span class="hljs-keyword">not</span> found. We<span class="hljs-string">'ll eat the exception and use our own observables
    implementation.
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h1 id="our-custom-observables-implementation-">Our custom observables implementation.</h1>
<p>This will be used if, and only if knockout is not found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">Observable</span> = <span class="hljs-params">(val)</span> -&gt;</span>
  _value = val

  subscriptions = []
<span class="hljs-function">
  <span class="hljs-title">callSubscribers</span> = <span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> subscriptions
      s _value
<span class="hljs-function">
  <span class="hljs-title">o</span> = <span class="hljs-params">(newVal)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> arguments.length &gt; <span class="hljs-number">0</span>
      isValueChanged = _value <span class="hljs-keyword">isnt</span> newVal
      _value = newVal

      <span class="hljs-keyword">if</span> isValueChanged
        callSubscribers()

    <span class="hljs-keyword">else</span>
      _value

  o.subscribe = <span class="hljs-function"><span class="hljs-params">(f)</span>-&gt;</span> subscriptions.push f
  o._isObservable = <span class="hljs-literal">true</span>

  o
<span class="hljs-function">

<span class="hljs-title">ObservableArray</span> = <span class="hljs-params">(arr)</span>-&gt;</span>
  _value = arr <span class="hljs-keyword">or</span> []
  <span class="hljs-keyword">unless</span> _value <span class="hljs-keyword">instanceof</span> Array
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error MSGInvalidArgumentsToObservableArray

  subscriptions = []
<span class="hljs-function">
  <span class="hljs-title">callSubscribers</span> = <span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> subscriptions
      s _value
<span class="hljs-function">
  <span class="hljs-title">o</span> = <span class="hljs-params">(newArr)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> arguments.length &gt; <span class="hljs-number">0</span>
      _value = newArr
      callSubscribers()

    <span class="hljs-keyword">else</span>
      _value

  o.subscribe = <span class="hljs-function"><span class="hljs-params">(f)</span>-&gt;</span> subscriptions.push f

  o.push = <span class="hljs-function"><span class="hljs-params">(v)</span>-&gt;</span>
    _value.push v
    callSubscribers()

  o.pop = <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    v = _value.pop()
    callSubscribers()
    v

  o._isObservable = <span class="hljs-literal">true</span>

  o</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h1 id="internal-utility-functions">Internal utility functions</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">_isObservable</span> = <span class="hljs-params">(v)</span>-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> ko <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span>
    ko.isObservable v
  <span class="hljs-keyword">else</span>
    v._isObservable <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>
<span class="hljs-function">

<span class="hljs-title">_unwrap</span> = <span class="hljs-params">(v)</span>-&gt;</span> <span class="hljs-keyword">if</span> _isObservable v <span class="hljs-keyword">then</span> v() <span class="hljs-keyword">else</span> v
<span class="hljs-function">

<span class="hljs-title">_isValid</span> = <span class="hljs-params">(observables, func)</span>-&gt;</span>
  <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> observables
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> _isObservable(o)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> _isObservable(func)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> func <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
  <span class="hljs-literal">true</span>
<span class="hljs-function">
<span class="hljs-title">_gather</span> = <span class="hljs-params">(observables)</span>-&gt;</span>
  values = []
  values.push _unwrap(o) <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> observables
  values</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h1 id="expose-observables-to-the-outside-world-">Expose observables to the outside world.</h1>
<p>This also decides whether to use ko or use Computeâ€™s observables.</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Usage</span>:
  x = Compute.o <span class="hljs-string">'foo'</span>
  <span class="hljs-built_in">console</span>.log x()      <span class="hljs-regexp">//</span>foo
  x <span class="hljs-string">'bar'</span>
  <span class="hljs-built_in">console</span>.log x()      <span class="hljs-regexp">//</span>bar</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.o = <span class="hljs-function"><span class="hljs-params">(val)</span>-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> ko <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span>
    ko.observable val
  <span class="hljs-keyword">else</span>
    Observable val</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Usage</span>:
  x = Compute.o [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>]
  <span class="hljs-built_in">console</span>.log x()      <span class="hljs-regexp">//</span>[<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>]
  x.push <span class="hljs-string">'bar'</span>
  <span class="hljs-built_in">console</span>.log x()      <span class="hljs-regexp">//</span>[<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.oa = <span class="hljs-function"><span class="hljs-params">(arr)</span>-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> ko <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span>
    ko.observableArray arr
  <span class="hljs-keyword">else</span>
    ObservableArray arr</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>Execute <span class="hljs-reserved">function</span> <span class="hljs-string">'f'</span> <span class="hljs-keyword">when</span> any <span class="hljs-keyword">of</span> the observables change. Pass observable values
as arguments.

<span class="hljs-attribute">Usage</span>:
  C.<span class="hljs-literal">on</span> obs1, obs2, obs3, <span class="hljs-function"><span class="hljs-params">(o1, o2, o3)</span>-&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"One of the observables changed!"</span>

grab the <span class="hljs-literal">on</span> like so
  t = C.<span class="hljs-literal">on</span> .....

Call t.$stop() to ignore subsequent observable mutations. Call t.$resume() to
resume. Call $fire() to force executing f <span class="hljs-reserved">with</span> current values <span class="hljs-keyword">of</span> all
observables.</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.<span class="hljs-literal">on</span> = <span class="hljs-function"><span class="hljs-params">(observables..., f)</span>-&gt;</span>
  <span class="hljs-keyword">unless</span> _isValid observables, f
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Invalid arguments to C.on'</span>
  isStopped = <span class="hljs-literal">false</span>
<span class="hljs-function">  <span class="hljs-title">func</span> = <span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> isStopped
    f.apply <span class="hljs-literal">null</span>, _gather(observables)

  o.subscribe func <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> observables

  $fire   : func
  $stop   : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span> isStopped = <span class="hljs-literal">true</span>
  $resume : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span> isStopped = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>Define a <span class="hljs-keyword">new</span> observable, whose value <span class="hljs-keyword">is</span> the value returned <span class="hljs-keyword">by</span> the <span class="hljs-reserved">function</span> <span class="hljs-string">'f'</span>
<span class="hljs-keyword">when</span> <span class="hljs-string">'f'</span> called <span class="hljs-reserved">with</span> the values <span class="hljs-keyword">of</span> all observables.

This <span class="hljs-keyword">new</span> observable <span class="hljs-keyword">is</span> updated every time one <span class="hljs-keyword">of</span> the observables mutate.

<span class="hljs-attribute">Usage</span>:
  C.<span class="hljs-literal">on</span> obs1, obs2, obs3, <span class="hljs-function"><span class="hljs-params">(o1, o2, o3)</span>-&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"One of the observables changed!"</span>

grab the <span class="hljs-literal">on</span> like so
  t = C.<span class="hljs-literal">on</span> .....

Call t.$stop() to ignore subsequent observable mutations. Call t.$resume() to
resume. Call $fire() to force executing f <span class="hljs-reserved">with</span> current values <span class="hljs-keyword">of</span> all
observables.</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.from = <span class="hljs-function"><span class="hljs-params">(observables..., f)</span>-&gt;</span>
  <span class="hljs-keyword">unless</span> _isValid observables, f
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Invalid arguments to C.from'</span>
  newOb = C.o()
  isStopped = <span class="hljs-literal">false</span>
<span class="hljs-function">  <span class="hljs-title">func</span> = <span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> isStopped
    val = f.apply <span class="hljs-literal">null</span>, _gather(observables)
    newOb val
    newOb

  o.subscribe func <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> observables
  newOb.$fire = func
  newOb.$stop = <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span> isStopped = <span class="hljs-literal">true</span>
  newOb.$resume = <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span> isStopped = <span class="hljs-literal">false</span>
  newOb</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h1 id="export-everything-on-compute">Export everything on Compute</h1>
<p>(Export internal util functions too, for testing).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>C._gather         = _gather
C._isValid        = _isValid
C._isObservable   = _isObservable
C._unwrap         = _unwrap
C.Observable      = Observable
C.ObservableArray = ObservableArray</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
